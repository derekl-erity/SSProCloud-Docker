services:
  ssprocloudserver:
    image: scottyhardy/docker-wine:stable-7.0
    restart: always
    entrypoint: /usr/bin/ssprocloud-entrypoint
    ports:
      - "127.0.0.1:3389:3389/tcp" # RDP (internal, through SSH tunnel only)
      - "${PCS_BIND_IP:-127.0.0.1}:1805:1805/tcp" # Pro Cloud Floating License (SSL)
    healthcheck:
      test: ["CMD-SHELL", "bash -lc ': >/dev/tcp/127.0.0.1/1805'"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 45s
    networks:
      ssprocloud:
        ipv4_address: ${BASE_IP}.2
    environment:
      ADMIN: ${ADMIN:-no}  # "yes" or "no"
      SSPROCLOUD_64BIT: ${SSPROCLOUD_64BIT:-yes}  # "yes" or "no"
    volumes:
      - ./winehome:/home/wineuser
      - ./entrypoint.sh:/usr/bin/ssprocloud-entrypoint
      - ./install.sh:/usr/bin/ssprocloud-install
      - ${SSL_CERT}:/home/wineuser/.wine/drive_c/Program Files/Sparx Systems/Pro Cloud Server/Service/server.pem
      - ${SSPROCLOUD_INSTALLER}:/home/wineuser/ssprocloud/ssprocloudserver.msi

  ssprocloudwebconfig:
    build: webconfig
    restart: always
    ports:
      - "${WEB_BIND_IP:-127.0.0.1}:1800:80/tcp"
    healthcheck:
      test: ["CMD-SHELL", "php -r \"exit(@file_get_contents('http://127.0.0.1/') === false ? 1 : 0);\""]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    networks:
      ssprocloud:
        ipv4_address: ${BASE_IP}.3
    volumes:
      - ./winehome/.wine/drive_c/Program Files/Sparx Systems/Pro Cloud Server/WebConfig:/var/www/html
      - ${WEBCONFIG_SETTINGS}:/var/www/html/settings.php

networks:
  ssprocloud:
    driver: bridge
    ipam:
      config:
        - subnet: ${BASE_IP}.0/16
          gateway: ${BASE_IP}.1
